<!DOCTYPE html>
<html>

<head>
  <title>Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
</head>

<body>
  <h1>Welcome to the Dashboard</h1>

  <h2>Tasks</h2>
  <ul id="taskList">
    <!-- Task items will be dynamically added here -->
  </ul>
  <script>
    async function updateTaskList(date='') {
      const taskList = document.getElementById('taskList');
      let time = new Date();
      time = transferTimeFromat(time);
      taskList.innerHTML = '';
      // Clear existing tasks
      try {
        // Query tasks from the server
        const tasksResponse = await fetch(`/tasks?date=${date}`);
        const tasks = await tasksResponse.json();

        // Iterate over the tasks and create list items
        tasks.forEach((task) => {
          const li = document.createElement('li');
          //console.log(time);
          if (task.reminderTime <= time) {
            const boldendl = document.createElement('li');
            const boldText = document.createElement('b');
            boldText.textContent = `${task.taskId} - ${task.name} -  ${task.startTime} - ${task.category} - ${task.priority} - ${task.reminderTime} - OVERDUE`;
            taskList.appendChild(boldText);
            taskList.appendChild(boldendl);
            //alert(`Task ${task.taskId} is OVERDUE`);
          }
          else {
            li.textContent = `${task.taskId} - ${task.name} -  ${task.startTime} - ${task.category} - ${task.priority} - ${task.reminderTime}`;
            taskList.appendChild(li);
          }
        });
      } catch (error) {
        console.error('Error fetching tasks:', error);
      }
      taskList.style.display = 'block';
    }
    setInterval(() => { updateTaskList }, 10000);
    updateTaskList();
  /*async function toupdate(){
        while(true){
          sleep(3000);
          updateTaskList();
        }
      }
      toupdate();
      */
    /*async function runPeriod(){
      while(true){
        await updateTaskList();
        await new Promise(resolve => setTimeout(resolve,30000));
      }
    }
    runPeriod();*/
    // Call the updateTaskList function to initially populate the task list

  </script>
  <form id="add-task-form">
    <div class="form-div">
      <label class="label">Task Name</label>
      <input type="text" id="name" name="name" placeholder="Enter task name" required>
    </div>
    <div class="form-div">
      <label class="label">Start Time</label>
      <input type="datetime-local" id="startTime" name="startTime" placeholder="Enter task start time" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}" required>
    </div>
    <div class="form-div">
      <label class="label">Priority</label>
      <input type="text" id="priority" name="priority" placeholder="Enter task priority" required>
    </div>
    <div class="form-div">
      <label class="label">Category</label>
      <input type="text" id="category" name="category" placeholder="Enter task category" required>
    </div>
    <div class="form-div">
      <label class="label">Reminder Time</label>
      <input type="datetime-local" id="reminderTime" name="reminderTime" placeholder="Enter task reminder time" required>
    </div>
    <button type="submit">Add Task</button>
  </form>

  
  <button type="button" onclick="queryByDate()">Query Task</button>

  <script>
    function queryByDate() {
      let date = '2023-07-11'
      updateTaskList(date);
    }
    document.getElementById('add-task-form').addEventListener('submit', function (event) {
      event.preventDefault(); // Prevent the default form submission

      const form = event.target;
      const name = form.name.value;
      const startTime = form.startTime.value;
      const priority = form.priority.value;
      const category = form.category.value;
      const reminderTime = form.reminderTime.value;

      fetch('/add-task', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, startTime:startTime.replace('T',' '), priority, category, reminderTime:reminderTime.replace('T',' ') })
      })
        .then(response => {
          if (response.ok) {
            // Task deleted successfully, perform any necessary actions
            console.log('Task added successfully');
            updateTaskList();
          } else {
            // Handle the error case
            console.error('Error adding task');
          }
        })
        .catch(error => {
          console.error('Error adding task:', error);
        });
    });
  </script>

  <form id="deleteTaskForm">
    <input type="text" id="taskId" name="taskId" placeholder="Enter task Id" required>
    <button type="submit">Delete Task</button>
  </form>

  <script>
    document.getElementById('deleteTaskForm').addEventListener('submit', function (event) {
      event.preventDefault(); // Prevent the default form submission

      const form = event.target;
      const taskId = form.taskId.value;

      fetch('/delete-task', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ taskId })
      })
        .then(response => {
          if (response.ok) {
            // Task deleted successfully, perform any necessary actions
            console.log('Task deleted successfully');
            updateTaskList();
          } else {
            // Handle the error case
            console.error('Error deleting task');
          }
        })
        .catch(error => {
          console.error('Error deleting task:', error);
        });
    });
  </script>
  <iframe src="https://free.timeanddate.com/clock/i8xhju0g/n237/tlcn/th1" frameborder="0" width="57"
    height="18"></iframe>

</body>

</html>